<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Geo-Insights Brasil</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; font-family: 'Inter', sans-serif; overflow: hidden; display: flex; }
        
        /* SIDEBAR (Painel Lateral) */
        #sidebar {
            width: 350px; height: 100vh; background: #fff; 
            box-shadow: 2px 0 10px rgba(0,0,0,0.1); z-index: 2000;
            display: flex; flex-direction: column;
            transform: translateX(-360px); /* Escondido por padrÃ£o */
            transition: transform 0.3s ease-in-out;
            position: absolute; left: 0; top: 0;
        }
        #sidebar.active { transform: translateX(0); }
        
        .sidebar-header { padding: 20px; background: #007bff; color: white; display: flex; justify-content: space-between; align-items: center; }
        .sidebar-content { padding: 20px; overflow-y: auto; flex: 1; }
        .close-btn { cursor: pointer; font-size: 1.5rem; background: none; border: none; color: white; }

        /* CARD DE MÃ‰TRICAS */
        .metric-card { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #007bff; }
        .metric-title { font-size: 0.85rem; color: #666; text-transform: uppercase; letter-spacing: 0.5px; }
        .metric-value { font-size: 1.5rem; font-weight: 600; color: #333; margin-top: 5px; }
        
        /* BARRA DE BUSCA (Flutuante) */
        .search-container {
            position: absolute; top: 20px; left: 60px; z-index: 1000;
            background: white; padding: 10px; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); width: 300px;
            transition: left 0.3s;
        }
        #sidebar.active ~ .search-container { left: 370px; } /* Empurra a busca se sidebar abrir */

        /* MAPA */
        #map { flex: 1; height: 100vh; }

        /* UTILS */
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        #suggestions { max-height: 200px; overflow-y: auto; background: white; border: 1px solid #eee; display: none; }
        .suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
        .suggestion-item:hover { background: #f0f8ff; }
        .loading { display: none; color: #007bff; font-size: 0.9em; margin-top: 5px; }
        .auth-btn { float: right; font-size: 0.8em; text-decoration: none; color: #555; }
    </style>
</head>
<body>

<!-- SIDEBAR -->
<div id="sidebar">
    <div class="sidebar-header">
        <h2 id="city-title" style="margin:0;">Detalhes</h2>
        <button class="close-btn" onclick="toggleSidebar()">Ã—</button>
    </div>
    <div class="sidebar-content">
        <div class="metric-card">
            <div class="metric-title">PopulaÃ§Ã£o (2022)</div>
            <div class="metric-value" id="val-pop">-</div>
        </div>
        <div class="metric-card" style="border-left-color: #28a745;">
            <div class="metric-title">PIB per Capita</div>
            <div class="metric-value" id="val-pib">-</div>
        </div>
        <div class="metric-card" style="border-left-color: #ffc107;">
            <div class="metric-title">Empresas Ativas</div>
            <div class="metric-value" id="val-companies">-</div>
        </div>
        <div class="metric-card" style="border-left-color: #17a2b8;">
            <div class="metric-title">Pessoal Ocupado</div>
            <div class="metric-value" id="val-workers">-</div>
        </div>
        <hr>
        <small style="color:#999;">Fonte: IBGE (Censo 2022, SIDRA, Malhas).</small>
    </div>
</div>

<!-- BUSCA -->
<div class="search-container">
    <div style="margin-bottom: 5px;">
        <strong>Geo-Insights</strong>
        <a id="authBtn" class="auth-btn" href="/view/login.html">Login</a>
    </div>
    <input type="text" id="search" placeholder="Buscar municÃ­pio..." autocomplete="off">
    <div id="suggestions"></div>
    <div id="loading" class="loading">ðŸ”„ Importando dados...</div>
</div>

<!-- MAPA -->
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // --- AUTH UI ---
    const token = localStorage.getItem('geo_token');
    const authBtn = document.getElementById('authBtn');
    if (token) {
        authBtn.innerText = "Sair";
        authBtn.href = "#";
        authBtn.onclick = () => { localStorage.removeItem('geo_token'); window.location.reload(); };
    }

    // --- MAPA ---
    const map = L.map('map').setView([-15.7, -47.8], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OSM' }).addTo(map);

    let citiesLayer = L.geoJSON(null, {
        style: (feature) => ({
            fillColor: getColor(feature.properties.population),
            weight: 2, opacity: 1, color: 'white', dashArray: '3', fillOpacity: 0.7
        }),
        onEachFeature: (feature, layer) => {
            // Tooltip simples no hover
            layer.bindTooltip(`<b>${feature.properties.name}</b>`, {direction: 'top'});
            
            // AÃ§Ã£o de Click
            layer.on('click', () => {
                // Passa as propriedades JÃ carregadas para a sidebar
                // Isso corrige o "undefined" instantaneamente
                updateSidebar(feature.properties);
                toggleSidebar(true);
            });
        }
    }).addTo(map);

    function getColor(d) {
        return d > 500000 ? '#800026' : d > 100000 ? '#BD0026' : d > 50000 ? '#E31A1C' :
               d > 10000 ? '#FD8D3C' : '#FEB24C';
    }

    // --- SIDEBAR LOGIC ---
    const sidebar = document.getElementById('sidebar');
    
    function toggleSidebar(show) {
        if (show) sidebar.classList.add('active');
        else sidebar.classList.remove('active');
    }

    function updateSidebar(props) {
        // CORREÃ‡ÃƒO: Usa o nome que veio do banco/mapa
        document.getElementById('city-title').innerText = props.name || "Cidade";
        
        // FormataÃ§Ãµes
        document.getElementById('val-pop').innerText = (props.population || 0).toLocaleString('pt-BR');
        
        const pib = props.pib_per_capita || 0;
        document.getElementById('val-pib').innerText = pib.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
        
        document.getElementById('val-companies').innerText = (props.total_companies || 0).toLocaleString('pt-BR');
        
        const workers = props.total_workers || 0;
        document.getElementById('val-workers').innerText = workers.toLocaleString('pt-BR');
        
        // ExibiÃ§Ã£o dos Anos (Hardcoded visualmente por enquanto ou dinÃ¢mico se salvÃ¡ssemos no banco)
        // Como nÃ£o salvamos o "ano" no banco ainda (apenas o valor), mostraremos uma mensagem genÃ©rica ou o dado do import
        // Futuramente: Adicionar coluna 'metadata_years' no banco.
    }

    // --- CARGA INICIAL ---
    async function loadMap() {
        try {
            const res = await fetch('/map');
            const data = await res.json();
            citiesLayer.clearLayers();
            citiesLayer.addData(data);
        } catch(e) { console.error(e); }
    }
    loadMap();

    // --- BUSCA & IMPORTAÃ‡ÃƒO ---
    const searchInput = document.getElementById('search');
    const suggestions = document.getElementById('suggestions');
    const loading = document.getElementById('loading');

    let debounce;
    searchInput.addEventListener('input', (e) => {
        clearTimeout(debounce);
        const q = e.target.value;
        if(q.length < 3) { suggestions.style.display = 'none'; return; }
        
        debounce = setTimeout(async () => {
            const res = await fetch(`/cities/search?q=${q}`);
            const list = await res.json();
            suggestions.innerHTML = '';
            suggestions.style.display = list.length ? 'block' : 'none';
            list.forEach(c => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.innerText = `${c.name} - ${c.uf}`;
                div.onclick = () => importCity(c.code);
                suggestions.appendChild(div);
            });
        }, 300);
    });

    async function importCity(code) {
        suggestions.style.display = 'none';
        loading.style.display = 'block';
        
        const headers = token ? { "Authorization": `Bearer ${token}` } : {};
        
        try {
            const res = await fetch(`/cities/import/${code}`, { method: 'POST', headers: headers });
            
            if (res.ok) {
                const responseJson = await res.json();
                console.log("Resposta ImportaÃ§Ã£o:", responseJson);
                
                loadMap(); // Recarrega mapa
                
                // --- CORREÃ‡ÃƒO AQUI: Atualiza e abre a Sidebar ---
                // O Backend retorna: { city: "Nome", data: { pib..., pop... }, metadata: {...} }
                const cityProps = {
                    name: responseJson.city,
                    ...responseJson.data // Espalha population, pib_total, etc
                };
                
                updateSidebar(cityProps);
                toggleSidebar(true);
                // -----------------------------------------------

            } else if (res.status === 401) {
                alert("ðŸ”’ FaÃ§a login para importar!");
            } else {
                alert("Erro ao importar.");
            }
        } catch(e) { 
            console.error(e); 
            alert("Erro de conexÃ£o.");
        } finally { 
            loading.style.display = 'none'; 
        }
    }
</script>
</body>
</html>