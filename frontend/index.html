<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geo-Insights Brasil</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        /* UI Flutuante */
        .ui-container {
            position: absolute; top: 20px; left: 60px; z-index: 1000;
            background: white; padding: 15px; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); width: 320px;
        }
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        h3 { margin: 0; font-size: 1.1rem; color: #333; }
        
        /* Bot√£o de Auth */
        .auth-btn { font-size: 0.8rem; padding: 5px 10px; border: 1px solid #ccc; background: #f8f9fa; border-radius: 4px; cursor: pointer; text-decoration: none; color: #333; }
        .auth-btn:hover { background: #e2e6ea; }
        .logout { color: #dc3545; border-color: #dc3545; color: white; background: #dc3545; }
        
        input { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; }
        #suggestions { max-height: 250px; overflow-y: auto; border: 1px solid #eee; display: none; background: white; margin-top: 5px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0; font-size: 0.9rem; }
        .suggestion-item:hover { background-color: #f0f8ff; color: #0056b3; }
        
        .loading { color: #007bff; font-size: 0.9em; display: none; margin-top: 10px; text-align: center; }
        .status-msg { font-size: 0.85em; margin-top: 10px; text-align: center; }
        .success { color: green; } .error { color: red; }
    </style>
</head>
<body>

<div class="ui-container">
    <div class="header-row">
        <h3>Explorador de Munic√≠pios</h3>
        <a id="authBtn" class="auth-btn" href="/login">Login</a>
    </div>
    
    <input type="text" id="search" placeholder="Buscar cidade (ex: Ouro Preto)..." autocomplete="off">
    <div id="suggestions"></div>
    
    <div id="loading" class="loading">
        üîÑ Conectando ao IBGE...<br><small>Isso pode levar alguns segundos.</small>
    </div>
    <div id="statusMsg" class="status-msg"></div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // --- 1. Gerenciamento de Auth ---
    const authBtn = document.getElementById('authBtn');
    
    function updateAuthUI() {
        const token = localStorage.getItem('geo_token');
        if (token) {
            authBtn.innerText = "Sair (Logout)";
            authBtn.classList.add("logout");
            authBtn.href = "#";
            authBtn.onclick = (e) => {
                e.preventDefault();
                localStorage.removeItem('geo_token');
                window.location.reload();
            };
        } else {
            authBtn.innerText = "Login (Admin)";
            authBtn.classList.remove("logout");
            authBtn.href = "/view/login.html";
            authBtn.onclick = null;
        }
    }
    updateAuthUI();

    // --- 2. Mapa Leaflet ---
    const map = L.map('map').setView([-15.7, -47.8], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OSM' }).addTo(map);

    let citiesLayer = L.geoJSON(null, {
        style: (feature) => ({
            fillColor: getColor(feature.properties.population),
            weight: 1, opacity: 1, color: 'white', fillOpacity: 0.7
        }),
        onEachFeature: (feature, layer) => {
            const p = feature.properties;
            
            // Formata√ß√µes
            const pop = (p.population || 0).toLocaleString('pt-BR');
            const pib = (p.pib_per_capita || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            const empresas = (p.total_companies || 0).toLocaleString('pt-BR');

            layer.bindPopup(`
                <div style="text-align:center">
                    <h3>${p.name}</h3>
                    <hr style="margin:5px 0; border:0; border-top:1px solid #ccc;">
                    <div style="text-align:left; line-height:1.6;">
                        üë• <b>Popula√ß√£o:</b> ${pop}<br>
                        üí∞ <b>PIB per Capita:</b> ${pib}<br>
                        üè¢ <b>Empresas Ativas:</b> ${empresas}
                    </div>
                </div>
            `);
        }
    }).addTo(map);

    function getColor(d) {
        return d > 500000 ? '#800026' : d > 100000 ? '#BD0026' : d > 50000 ? '#E31A1C' :
               d > 10000 ? '#FD8D3C' : '#FEB24C';
    }

    async function loadMap() {
        try {
            const res = await fetch('/map');
            const data = await res.json();
            citiesLayer.clearLayers();
            citiesLayer.addData(data);
            if (data.features.length > 0) {
                // Foca apenas se tiver dados, sen√£o mant√©m vis√£o Brasil
                const group = new L.featureGroup(citiesLayer.getLayers());
                map.fitBounds(group.getBounds().pad(0.1));
            }
        } catch(e) { console.error("Erro ao carregar mapa", e); }
    }
    loadMap(); // Carrega ao iniciar

    // --- 3. Busca e Importa√ß√£o ---
    const searchInput = document.getElementById('search');
    const suggestions = document.getElementById('suggestions');
    const loading = document.getElementById('loading');
    const statusMsg = document.getElementById('statusMsg');

    // Debounce para n√£o floodar a API
    let debounceTimer;
    searchInput.addEventListener('input', (e) => {
        clearTimeout(debounceTimer);
        const query = e.target.value;
        statusMsg.innerText = "";
        
        if (query.length < 3) { suggestions.style.display = 'none'; return; }

        debounceTimer = setTimeout(async () => {
            try {
                const res = await fetch(`/cities/search?q=${query}`);
                const list = await res.json();
                
                suggestions.innerHTML = '';
                suggestions.style.display = list.length ? 'block' : 'none';
                
                list.forEach(city => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.innerText = `${city.name} - ${city.uf}`;
                    div.onclick = () => importCity(city.code, city.name);
                    suggestions.appendChild(div);
                });
            } catch (e) { console.error(e); }
        }, 300);
    });

    async function importCity(code, name) {
        suggestions.style.display = 'none';
        searchInput.value = name;
        loading.style.display = 'block';
        statusMsg.innerText = "";

        const token = localStorage.getItem('geo_token');
        const headers = token ? { "Authorization": `Bearer ${token}` } : {};

        try {
            const res = await fetch(`/cities/import/${code}`, { 
                method: 'POST',
                headers: headers 
            });
            
            if (res.status === 401) {
                statusMsg.innerHTML = "<span class='error'>üîí Fa√ßa Login para importar dados!</span>";
                alert("Voc√™ precisa estar logado! Clique no bot√£o Login.");
            } else if (res.ok) {
                statusMsg.innerHTML = `<span class='success'>‚úÖ ${name} importada com sucesso!</span>`;
                loadMap(); // Atualiza o mapa
            } else {
                const err = await res.json();
                statusMsg.innerHTML = `<span class='error'>‚ùå Erro: ${err.detail || 'Falha na API'}</span>`;
            }
        } catch (e) {
            statusMsg.innerHTML = "<span class='error'>‚ùå Erro de conex√£o</span>";
        } finally {
            loading.style.display = 'none';
        }
    }
</script>
</body>
</html>