<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geo-Insights Brasil</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: sans-serif; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        /* UI Sobreposta */
        .ui-container {
            position: absolute; top: 10px; left: 50px; z-index: 1000;
            background: white; padding: 10px; border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2); width: 300px;
        }
        input { width: 100%; padding: 8px; box-sizing: border-box; }
        #suggestions { 
            max-height: 200px; overflow-y: auto; border: 1px solid #ccc; 
            display: none; background: white;
        }
        .suggestion-item { padding: 8px; cursor: pointer; border-bottom: 1px solid #eee; }
        .suggestion-item:hover { background-color: #f0f0f0; }
        
        .loading { color: blue; font-size: 0.9em; display: none; }
        .auth-warning { color: red; font-size: 0.8em; margin-top: 5px; display: none; }
    </style>
</head>
<body>

<div class="ui-container">
    <h3>Adicionar Munic√≠pio</h3>
    <input type="text" id="search" placeholder="Digite o nome (ex: Atibaia)..." autocomplete="off">
    <div id="suggestions"></div>
    <div id="loading" class="loading">‚è≥ Importando dados do IBGE...</div>
    <div id="auth-msg" class="auth-warning">‚ö†Ô∏è Voc√™ precisa estar logado no Swagger ou ter o token. (Demo: Importa√ß√£o falhar√° se n√£o tiver token no browser, use o Swagger para testar o POST)</div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // 1. Mapa Base
    const map = L.map('map').setView([-15.7, -47.8], 4); // Vis√£o Brasil
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OSM' }).addTo(map);

    // Camada de Cidades
    let citiesLayer = L.geoJSON(null, {
        style: (feature) => ({
            fillColor: getColor(feature.properties.population),
            weight: 1, opacity: 1, color: 'white', fillOpacity: 0.7
        }),
        onEachFeature: (feature, layer) => {
            layer.bindPopup(`<b>${feature.properties.name}</b><br>Popula√ß√£o: ${feature.properties.population}`);
        }
    }).addTo(map);

    function getColor(d) {
        return d > 500000 ? '#800026' : d > 100000 ? '#BD0026' : d > 50000 ? '#E31A1C' :
               d > 10000 ? '#FD8D3C' : '#FEB24C';
    }

    // 2. Carregar Mapa Inicial
    function loadMap() {
        fetch('/map').then(r => r.json()).then(data => {
            citiesLayer.clearLayers();
            citiesLayer.addData(data);
            if (data.features.length > 0) {
                map.fitBounds(citiesLayer.getBounds());
            }
        });
    }
    loadMap();

    // 3. L√≥gica de Busca
    const searchInput = document.getElementById('search');
    const suggestions = document.getElementById('suggestions');
    const loading = document.getElementById('loading');

    searchInput.addEventListener('input', async (e) => {
        const query = e.target.value;
        if (query.length < 3) { suggestions.style.display = 'none'; return; }

        const res = await fetch(`/cities/search?q=${query}`);
        const list = await res.json();
        
        suggestions.innerHTML = '';
        suggestions.style.display = list.length ? 'block' : 'none';
        
        list.forEach(city => {
            const div = document.createElement('div');
            div.className = 'suggestion-item';
            div.innerText = `${city.name} - ${city.uf}`;
            div.onclick = () => importCity(city.code);
            suggestions.appendChild(div);
        });
    });

    // 4. Importar Cidade (Aten√ß√£o: Requer Auth)
    async function importCity(code) {
        suggestions.style.display = 'none';
        searchInput.value = '';
        loading.style.display = 'block';

        // NOTA: Em um app real, o token JWT estaria salvo no LocalStorage
        // Aqui vamos tentar chamar, se der 401 avisamos
        
        // PEGANDO O TOKEN DO LOCALSTORAGE (Simula√ß√£o)
        // Para testar via browser, voc√™ teria que implementar login no front.
        // Vamos assumir que voc√™ testar√° a importa√ß√£o via Swagger e o front s√≥ l√™.
        // MAS, vou deixar o fetch aqui. Se der 401, aparecer√° o alerta.
        
        const token = localStorage.getItem("token"); // Implementaremos login no front depois
        const headers = token ? { "Authorization": `Bearer ${token}` } : {};

        try {
            const res = await fetch(`/cities/import/${code}`, { 
                method: 'POST',
                headers: headers 
            });
            
            if (res.status === 401) {
                alert("üîí Erro: Voc√™ precisa estar autenticado para importar dados!");
            } else if (res.ok) {
                loadMap(); // Recarrega o mapa com a nova cidade
            } else {
                alert("Erro ao importar cidade.");
            }
        } catch (e) {
            console.error(e);
        } finally {
            loading.style.display = 'none';
        }
    }
</script>
</body>
</html>