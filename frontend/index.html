<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Geo-Insights Brasil</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; font-family: 'Inter', sans-serif; overflow: hidden; display: flex; }
        #sidebar { width: 350px; height: 100vh; background: #fff; box-shadow: 2px 0 10px rgba(0,0,0,0.1); z-index: 2000; display: flex; flex-direction: column; transform: translateX(-360px); transition: transform 0.3s ease-in-out; position: absolute; left: 0; top: 0; }
        #sidebar.active { transform: translateX(0); }
        .sidebar-header { padding: 20px; background: #007bff; color: white; display: flex; justify-content: space-between; align-items: center; }
        .sidebar-content { padding: 20px; overflow-y: auto; flex: 1; }
        .close-btn { cursor: pointer; font-size: 1.5rem; background: none; border: none; color: white; }
        .metric-card { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #007bff; }
        .metric-title { font-size: 0.85rem; color: #666; text-transform: uppercase; letter-spacing: 0.5px; }
        .metric-value { font-size: 1.5rem; font-weight: 600; color: #333; margin-top: 5px; }
        .search-container { position: absolute; top: 20px; left: 60px; z-index: 1000; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); width: 300px; transition: left 0.3s; }
        #sidebar.active ~ .search-container { left: 370px; }
        #map { flex: 1; height: 100vh; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        #suggestions { max-height: 200px; overflow-y: auto; background: white; border: 1px solid #eee; display: none; }
        .suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
        .suggestion-item:hover { background: #f0f8ff; }
        .loading { display: none; color: #007bff; font-size: 0.9em; margin-top: 5px; }
        .auth-btn { float: right; font-size: 0.8em; text-decoration: none; color: #555; }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="sidebar-header">
        <h2 id="city-title" style="margin:0;">Detalhes</h2>
        <button class="close-btn" onclick="toggleSidebar(false)">Ã—</button>
    </div>
    <div class="sidebar-content">
        <div class="metric-card">
            <div class="metric-title">PopulaÃ§Ã£o</div>
            <div class="metric-value" id="val-pop">-</div>
        </div>
        <div class="metric-card" style="border-left-color: #28a745;">
            <div class="metric-title">PIB per Capita</div>
            <div class="metric-value" id="val-pib">-</div>
        </div>
        <div class="metric-card" style="border-left-color: #ffc107;">
            <div class="metric-title">Empresas Ativas</div>
            <div class="metric-value" id="val-companies">-</div>
        </div>
        <div class="metric-card" style="border-left-color: #17a2b8;">
            <div class="metric-title">PopulaÃ§Ã£o Empregada</div>
            <div class="metric-value" id="val-workers">-</div>
        </div>
        <hr>
        <small style="color:#999;">Fonte: IBGE (Censo 2022, SIDRA, Malhas).</small>
    </div>
</div>

<div class="search-container">
    <div style="margin-bottom: 5px;">
        <strong>Geo-Insights</strong>
        <a id="authBtn" class="auth-btn" href="/view/login.html">Login</a>
    </div>
    <input type="text" id="search" placeholder="Buscar municÃ­pio..." autocomplete="off">
    <div id="suggestions"></div>
    <div id="loading" class="loading">ðŸ”„ Importando dados...</div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const token = localStorage.getItem('geo_token');
    const authBtn = document.getElementById('authBtn');
    if (token) {
        authBtn.innerText = "Sair";
        authBtn.href = "#";
        authBtn.onclick = () => { localStorage.removeItem('geo_token'); window.location.reload(); };
    }

    const map = L.map('map').setView([-15.7, -47.8], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OSM' }).addTo(map);

    let citiesLayer = L.geoJSON(null, {
        style: (feature) => ({
            fillColor: getColor(feature.properties.population),
            weight: 2, opacity: 1, color: 'white', dashArray: '3', fillOpacity: 0.7
        }),
        onEachFeature: (feature, layer) => {
            const props = feature.properties;
            // Tooltip Robusto
            const name = props.name || props.NM_MUN || "Cidade";
            layer.bindTooltip(`<b>${name}</b>`, { direction: 'top', permanent: false, opacity: 0.9 });
            
            layer.on('click', () => {
                updateSidebar(props);
                toggleSidebar(true);
            });
        }
    }).addTo(map);

    function getColor(d) {
        return d > 500000 ? '#800026' : d > 100000 ? '#BD0026' : d > 50000 ? '#E31A1C' : d > 10000 ? '#FD8D3C' : '#FEB24C';
    }

    const sidebar = document.getElementById('sidebar');
    function toggleSidebar(show) {
        if (show) sidebar.classList.add('active');
        else sidebar.classList.remove('active');
    }

    function updateSidebar(props) {
        document.getElementById('city-title').innerText = props.name || "Cidade";
        const showYear = (y) => y ? `(${y})` : '';
        const fmtNum = (n) => (n !== undefined && n !== null) ? n.toLocaleString('pt-BR') : '-';
        const fmtMoney = (n) => (n !== undefined && n !== null) ? n.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'}) : '-';

        document.getElementById('val-pop').innerHTML = `${fmtNum(props.population)} <small style='font-size:0.6em; color:#777'>(2022)</small>`;
        document.getElementById('val-pib').innerHTML = `${fmtMoney(props.pib_per_capita)} <small style='font-size:0.6em; color:#777'>${showYear(props.pib_year)}</small>`;
        document.getElementById('val-companies').innerHTML = `${fmtNum(props.total_companies)} <small style='font-size:0.6em; color:#777'>${showYear(props.companies_year)}</small>`;
        document.getElementById('val-workers').innerHTML = `${fmtNum(props.total_workers)} <small style='font-size:0.6em; color:#777'>${showYear(props.companies_year)}</small>`;
    }

    async function loadMap() {
        try {
            const res = await fetch('/map');
            const data = await res.json();
            
            // --- DEBUG VISUAL ---
            console.log("ðŸ“ GeoJSON do Backend:", data);
            if (data.features.length > 0) {
                console.log("Exemplo de Propriedades:", data.features[0].properties);
            }
            // --------------------

            citiesLayer.clearLayers();
            citiesLayer.addData(data);
        } catch(e) { console.error(e); }
    }
    loadMap();

    const searchInput = document.getElementById('search');
    const suggestions = document.getElementById('suggestions');
    const loading = document.getElementById('loading');
    let debounce;

    searchInput.addEventListener('input', (e) => {
        clearTimeout(debounce);
        const q = e.target.value;
        if(q.length < 3) { suggestions.style.display = 'none'; return; }
        
        debounce = setTimeout(async () => {
            try {
                const res = await fetch(`/cities/search?q=${q}`);
                const list = await res.json();
                suggestions.innerHTML = '';
                suggestions.style.display = list.length ? 'block' : 'none';
                list.forEach(c => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.innerText = `${c.name} - ${c.uf}`;
                    div.onclick = () => importCity(c.code, c.name); // Passa nome aqui tambÃ©m
                    suggestions.appendChild(div);
                });
            } catch(e) { console.error(e); }
        }, 300);
    });

    async function importCity(code, searchName) {
        suggestions.style.display = 'none';
        loading.style.display = 'block';
        if(searchName) searchInput.value = searchName;
        
        const headers = token ? { "Authorization": `Bearer ${token}` } : {};
        
        try {
            const res = await fetch(`/cities/import/${code}`, { method: 'POST', headers: headers });
            
            if (res.ok) {
                const responseJson = await res.json();
                
                // 1. Atualiza Sidebar IMEDIATAMENTE (Cache Local)
                const cityProps = {
                    name: responseJson.city, 
                    ...responseJson.data 
                };
                updateSidebar(cityProps);
                toggleSidebar(true);

                // 2. Atualiza Mapa (Background)
                await loadMap(); 

            } else if (res.status === 401) {
                alert("ðŸ”’ FaÃ§a login para importar!");
            } else {
                alert("Erro ao importar.");
            }
        } catch(e) { console.error(e); alert("Erro de conexÃ£o."); } 
        finally { loading.style.display = 'none'; }
    }
</script>
</body>
</html>